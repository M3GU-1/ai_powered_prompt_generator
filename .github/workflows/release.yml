name: Release

on:
  push:
    tags:
      - 'v*'

permissions:
  contents: write

jobs:
  release:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          lfs: true

      - name: Get version from tag
        id: version
        run: echo "VERSION=${GITHUB_REF#refs/tags/}" >> "$GITHUB_OUTPUT"

      - name: Create release package
        env:
          VERSION: ${{ steps.version.outputs.VERSION }}
        run: |
          PKG_NAME="sd-prompt-tag-generator-${VERSION}"

          mkdir -p "${PKG_NAME}"

          # Copy project files
          cp -r backend/ "${PKG_NAME}/backend/"
          cp -r frontend/ "${PKG_NAME}/frontend/"
          cp -r scripts/ "${PKG_NAME}/scripts/"
          cp danbooru_tags.csv "${PKG_NAME}/"
          cp anima_danbooru.csv "${PKG_NAME}/"
          cp config.example.yaml "${PKG_NAME}/"
          cp requirements.txt "${PKG_NAME}/"
          cp start.sh "${PKG_NAME}/"
          cp start.bat "${PKG_NAME}/"
          cp README.md "${PKG_NAME}/"

          # Ensure start.sh is executable
          chmod +x "${PKG_NAME}/start.sh"

          # Create zip and tar.gz
          zip -r "${PKG_NAME}.zip" "${PKG_NAME}/"
          tar -czf "${PKG_NAME}.tar.gz" "${PKG_NAME}/"

      - name: Create tag index archives
        run: |
          for source in danbooru anima merged; do
            if [ -d "data/${source}" ]; then
              tar -czf "tag-index-${source}.tar.gz" -C data "${source}"
              echo "Created tag-index-${source}.tar.gz ($(du -h tag-index-${source}.tar.gz | cut -f1))"
            fi
          done

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        env:
          VERSION: ${{ steps.version.outputs.VERSION }}
        with:
          name: "SD Prompt Tag Generator ${{ steps.version.outputs.VERSION }}"
          body: |
            ## 다운로드 및 실행 방법

            1. 아래에서 `.zip` (Windows) 또는 `.tar.gz` (Mac/Linux) 파일을 다운로드합니다
            2. 압축을 풀고 폴더로 이동합니다
            3. 아래 태그 인덱스 파일을 다운로드하여 **같은 폴더에 그대로 넣습니다** (압축 해제 불필요!)
            4. 실행합니다:
               - **Windows**: `start.bat` 더블클릭
               - **Mac/Linux**: 터미널에서 `./start.sh` 실행
            5. 첫 실행 시 자동으로:
               - 태그 인덱스 압축 해제
               - `config.yaml` 설정 파일 생성
               - 필요한 패키지 설치

            > 브라우저가 열리면 화면의 설정 패널에서 API 키를 입력하면 바로 사용할 수 있습니다.

            ### 태그 인덱스 (하나만 받으면 됩니다)

            | 파일 | 설명 | 태그 수 |
            |------|------|---------|
            | `tag-index-merged.tar.gz` | **통합 (권장)** | 183,700 |
            | `tag-index-danbooru.tar.gz` | Danbooru만 | 32,259 |
            | `tag-index-anima.tar.gz` | Anima만 | 183,174 |

            > 3개 중 필요한 것만 다운로드하세요. 잘 모르겠다면 **merged 하나만** 받으면 됩니다.
            > 인덱스 없이도 실행 가능하지만, 첫 실행 시 임베딩 빌드에 10~20분이 소요됩니다.
            > Git Clone 사용자는 Git LFS로 인덱스가 자동 포함되므로 별도 다운로드가 불필요합니다.

            ### 사전 요구사항
            - Python 3.10 이상
            - OpenAI / Google Gemini API 키 (또는 Ollama)
          files: |
            sd-prompt-tag-generator-*.zip
            sd-prompt-tag-generator-*.tar.gz
            tag-index-*.tar.gz
          draft: false
          prerelease: false
