name: Release

on:
  push:
    tags:
      - 'v*'

permissions:
  contents: write

jobs:
  release:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          lfs: true

      - name: Get version from tag
        id: version
        run: echo "VERSION=${GITHUB_REF#refs/tags/}" >> "$GITHUB_OUTPUT"

      - name: Create release package
        env:
          VERSION: ${{ steps.version.outputs.VERSION }}
        run: |
          PKG_NAME="sd-prompt-tag-generator-${VERSION}"

          mkdir -p "${PKG_NAME}"

          # Copy project files
          cp -r backend/ "${PKG_NAME}/backend/"
          cp -r frontend/ "${PKG_NAME}/frontend/"
          cp -r scripts/ "${PKG_NAME}/scripts/"
          cp danbooru_tags.csv "${PKG_NAME}/"
          cp anima_danbooru.csv "${PKG_NAME}/"
          cp config.example.yaml "${PKG_NAME}/"
          cp requirements.txt "${PKG_NAME}/"
          cp start.sh "${PKG_NAME}/"
          cp start.bat "${PKG_NAME}/"
          cp README.md "${PKG_NAME}/"

          # Ensure start.sh is executable
          chmod +x "${PKG_NAME}/start.sh"

          # Create zip and tar.gz
          zip -r "${PKG_NAME}.zip" "${PKG_NAME}/"
          tar -czf "${PKG_NAME}.tar.gz" "${PKG_NAME}/"

      - name: Create tag index archives
        run: |
          for source in danbooru anima merged; do
            if [ -d "data/${source}" ]; then
              tar -czf "tag-index-${source}.tar.gz" -C data "${source}"
              echo "Created tag-index-${source}.tar.gz ($(du -h tag-index-${source}.tar.gz | cut -f1))"
            fi
          done

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        env:
          VERSION: ${{ steps.version.outputs.VERSION }}
        with:
          name: "SD Prompt Tag Generator ${{ steps.version.outputs.VERSION }}"
          body: |
            ## 다운로드 및 실행 방법

            1. 아래에서 `.zip` (Windows) 또는 `.tar.gz` (Mac/Linux) 파일을 다운로드합니다
            2. 압축을 풀고 폴더로 이동합니다
            3. `config.example.yaml`을 `config.yaml`로 복사하고 API 키를 입력합니다
            4. 실행합니다:
               - **Windows**: `start.bat` 더블클릭
               - **Mac/Linux**: 터미널에서 `./start.sh` 실행

            ### 태그 인덱스 (선택 다운로드)

            임베딩 빌드(10~20분) 없이 바로 사용하려면, 아래에서 인덱스를 다운로드하여
            프로젝트의 `data/` 폴더에 압축 해제하세요:

            | 파일 | 설명 | 태그 수 |
            |------|------|---------|
            | `tag-index-merged.tar.gz` | 통합 (권장) | 183,700 |
            | `tag-index-danbooru.tar.gz` | Danbooru만 | 32,259 |
            | `tag-index-anima.tar.gz` | Anima만 | 183,174 |

            ```bash
            # 예시: merged 인덱스 설치
            tar -xzf tag-index-merged.tar.gz -C data/
            ```

            > 인덱스를 다운로드하면 첫 실행 시 임베딩 빌드가 자동으로 스킵됩니다.
            > Git Clone 사용자는 Git LFS로 인덱스가 자동 포함되므로 별도 다운로드가 불필요합니다.

            ### 사전 요구사항
            - Python 3.10 이상
            - OpenAI / Google Gemini API 키 (또는 Ollama)
          files: |
            sd-prompt-tag-generator-*.zip
            sd-prompt-tag-generator-*.tar.gz
            tag-index-*.tar.gz
          draft: false
          prerelease: false
